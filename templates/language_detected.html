<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Detection - ML Pipeline</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            margin: 40px auto;
            padding: 40px;
            max-width: 1000px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .progress-step {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }
        .step.active .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step.completed .step-number {
            background: #28a745;
        }
        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }
        .step:last-child::after {
            display: none;
        }
        .language-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            text-align: center;
        }
        .sample-text {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Progress Steps -->
        <div class="progress-step">
            <div class="step completed">
                <div class="step-number">1</div>
                <small>Upload Dataset</small>
            </div>
            <div class="step completed">
                <div class="step-number">2</div>
                <small>Data Overview</small>
            </div>
            <div class="step completed">
                <div class="step-number">3</div>
                <small>Language Detection</small>
            </div>
            <div class="step active">
                <div class="step-number">4</div>
                <small>Sentiment Analysis</small>
            </div>
            <div class="step">
                <div class="step-number">5</div>
                <small>Feature Engineering</small>
            </div>
            <div class="step">
                <div class="step-number">6</div>
                <small>Model Training</small>
            </div>
            <div class="step">
                <div class="step-number">7</div>
                <small>Results</small>
            </div>
        </div>

        <div class="text-center mb-4">
            <h1 class="display-4 text-primary">
                <i class="fas fa-language me-3"></i>Language Detection
            </h1>
            <p class="lead text-muted">Analyzing language distribution in your dataset</p>
        </div>

        <!-- Dataset Info -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5><i class="fas fa-database me-2"></i>Dataset: <span id="datasetName">{{ dataset_name }}</span></h5>
                        <p class="text-muted mb-0">Total samples: <strong id="totalSamples">Loading...</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Language Analysis Results -->
        <div class="row" id="analysisResults" style="display: none;">
            <div class="col-md-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>Language Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="languageChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="language-card">
                    <h3 id="primaryLanguage">English</h3>
                    <p>Primary Language</p>
                    <h2 id="primaryPercentage">75%</h2>
                </div>
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle text-primary me-2"></i>Detection Summary</h6>
                        <ul class="small mb-0" id="languageSummary">
                            <li>English: <span id="englishCount">0</span> samples</li>
                            <li>Kiswahili: <span id="kiswahiliCount">0</span> samples</li>
                            <li>Mixed: <span id="mixedCount">0</span> samples</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Embedding Model Selection -->
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-body text-center">
                        <h6><i class="fas fa-robot text-success me-2"></i>Embedding Model Selected</h6>
                        <div class="bg-light p-3 rounded">
                            <h5 class="mb-0" id="embeddingModel">BERT</h5>
                            <small class="text-muted" id="embeddingReason">Based on language analysis</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Texts -->
        <div class="row mt-4" id="sampleSection" style="display: none;">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h6><i class="fas fa-flag text-success me-2"></i>English Samples</h6>
                    </div>
                    <div class="card-body">
                        <div id="englishSamples"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h6><i class="fas fa-flag text-info me-2"></i>Kiswahili Samples</h6>
                    </div>
                    <div class="card-body">
                        <div id="kiswahiliSamples"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h6><i class="fas fa-flag text-warning me-2"></i>Mixed Samples</h6>
                    </div>
                    <div class="card-body">
                        <div id="mixedSamples"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Status -->
        <div class="text-center" id="processingStatus">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing language patterns in your dataset...</p>
        </div>

        <!-- Next Steps -->
        <div class="mt-5" id="nextSteps" style="display: none;">
            <h4 class="text-center mb-4">
                <i class="fas fa-arrow-right me-2"></i>Next Steps
            </h4>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-heart text-danger mb-3" style="font-size: 2rem;"></i>
                            <h5>Sentiment Analysis</h5>
                            <p class="text-muted">Analyze emotional tone and sentiment patterns in your dataset using language-adaptive models.</p>
                            <button type="button" class="btn btn-outline-primary" onclick="proceedToSentiment()">
                                <i class="fas fa-play me-2"></i>Start Sentiment Analysis
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-search text-info mb-3" style="font-size: 2rem;"></i>
                            <h5>Skip to Feature Engineering</h5>
                            <p class="text-muted">Proceed directly to comprehensive feature extraction including all theoretical frameworks.</p>
                            <button type="button" class="btn btn-primary" onclick="proceedToFeatures()">
                                <i class="fas fa-cogs me-2"></i>Extract Features
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Sentiment analysis will enhance your feature set with emotional context and theoretical framework insights.
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let datasetName = "{{ dataset_name }}";
        let languageData = {};
        let languageChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Start language detection automatically
            performLanguageDetection();
        });

        async function performLanguageDetection() {
            try {
                const response = await fetch(`/api/detect_language/${datasetName}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    languageData = result.data;
                    displayResults();
                } else {
                    throw new Error(result.error || 'Language detection failed');
                }
                
            } catch (error) {
                document.getElementById('processingStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Language Detection Failed</h5>
                        <p class="mb-0">${error.message}</p>
                        <button class="btn btn-outline-danger mt-2" onclick="performLanguageDetection()">
                            <i class="fas fa-redo me-2"></i>Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayResults() {
            // Hide processing status
            document.getElementById('processingStatus').style.display = 'none';
            
            // Show results
            document.getElementById('analysisResults').style.display = 'block';
            document.getElementById('sampleSection').style.display = 'block';
            document.getElementById('nextSteps').style.display = 'block';

            // Update dataset info
            document.getElementById('totalSamples').textContent = languageData.total_samples_analyzed;

            // Update language counts
            document.getElementById('englishCount').textContent = languageData.english_samples || 0;
            document.getElementById('kiswahiliCount').textContent = languageData.kiswahili_samples || 0;
            document.getElementById('mixedCount').textContent = languageData.mixed_samples || 0;

            // Update primary language
            document.getElementById('primaryLanguage').textContent = languageData.dominant_language;
            const englishPercentage = (languageData.language_distribution.English * 100).toFixed(1);
            document.getElementById('primaryPercentage').textContent = englishPercentage + '%';
            
            // Update embedding model information
            document.getElementById('embeddingModel').textContent = languageData.embedding_model;
            let reason;
            if (languageData.embedding_model === 'BERT') {
                reason = 'Primarily English text detected';
            } else if (languageData.dominant_language === 'Kiswahili') {
                reason = 'Kiswahili text detected - using multilingual model';
            } else {
                reason = 'Mixed languages detected - using multilingual model';
            }
            document.getElementById('embeddingReason').textContent = reason;

            // Create chart
            createLanguageChart();

            // Display sample texts
            displaySampleTexts();
        }

        function createLanguageChart() {
            const ctx = document.getElementById('languageChart').getContext('2d');
            const distribution = languageData.language_distribution;
            
            languageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(distribution).map(lang => lang.charAt(0).toUpperCase() + lang.slice(1)),
                    datasets: [{
                        data: Object.values(distribution).map(val => (val * 100).toFixed(1)),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function displaySampleTexts() {
            // Display English samples
            const englishContainer = document.getElementById('englishSamples');
            if (languageData.samples && languageData.samples.english && languageData.samples.english.length > 0) {
                englishContainer.innerHTML = languageData.samples.english.slice(0, 3).map(text => `
                    <div class="sample-text mb-2">
                        <small class="text-muted">"${text}"</small>
                    </div>
                `).join('');
            } else {
                englishContainer.innerHTML = '<p class="text-muted text-center small">No English samples found</p>';
            }

            // Display Kiswahili samples
            const kiswahiliContainer = document.getElementById('kiswahiliSamples');
            if (languageData.samples && languageData.samples.kiswahili && languageData.samples.kiswahili.length > 0) {
                kiswahiliContainer.innerHTML = languageData.samples.kiswahili.slice(0, 3).map(text => `
                    <div class="sample-text mb-2">
                        <small class="text-muted">"${text}"</small>
                    </div>
                `).join('');
            } else {
                kiswahiliContainer.innerHTML = '<p class="text-muted text-center small">No Kiswahili samples found</p>';
            }

            // Display Mixed samples
            const mixedContainer = document.getElementById('mixedSamples');
            if (languageData.samples && languageData.samples.mixed && languageData.samples.mixed.length > 0) {
                mixedContainer.innerHTML = languageData.samples.mixed.slice(0, 3).map(text => `
                    <div class="sample-text mb-2">
                        <small class="text-muted">"${text}"</small>
                    </div>
                `).join('');
            } else {
                mixedContainer.innerHTML = '<p class="text-muted text-center small">No mixed samples found</p>';
            }
        }

        function goBack() {
            window.location.href = '/upload_new';
        }

        function proceedToSentiment() {
            window.location.href = `/sentiment_analysis/${datasetName}`;
        }
        
        function proceedToFeatures() {
            window.location.href = `/feature_extraction/${datasetName}`;
        }
    </script>
</body>
</html>