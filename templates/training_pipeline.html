{% extends "base.html" %}

{% block title %}Training Pipeline - {{ dataset_name }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
    }
    
    body {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .main-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        margin: 40px auto;
        padding: 40px;
        max-width: 1200px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .training-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .progress-steps {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 30px 0;
        padding: 20px;
    }
    
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        max-width: 150px;
    }
    
    .step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 20px;
        left: 60%;
        width: 80%;
        height: 2px;
        background: #dee2e6;
        z-index: 0;
    }
    
    .step.completed:not(:last-child)::after {
        background: linear-gradient(90deg, var(--success-color), #20c997);
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
    }
    
    .step.completed .step-number {
        background: linear-gradient(135deg, var(--success-color), #20c997);
        color: white;
    }
    
    .step.active .step-number {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .pipeline-step {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin: 15px 0;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        border-left: 5px solid #6c757d;
    }
    
    .step-completed {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #f8fff9 0%, #e8f8e8 100%);
    }
    
    .step-running {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #fffdf5 0%, #fff8e1 100%);
        animation: glow 2s infinite;
    }
    
    .step-error {
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
    }
    
    .step-pending {
        border-left-color: #6c757d;
        background: #f8f9fa;
        opacity: 0.8;
    }
    
    @keyframes glow {
        0%, 100% { box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        50% { box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3); }
    }
    
    .step-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .badge-completed { background: var(--success-color); color: white; }
    .badge-running { background: var(--warning-color); color: #212529; }
    .badge-error { background: var(--danger-color); color: white; }
    .badge-pending { background: #6c757d; color: white; }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-ready { background-color: var(--success-color); }
    .status-running { 
        background-color: var(--warning-color); 
        animation: pulse-dot 1s infinite;
    }
    .status-error { background-color: var(--danger-color); }
    .status-pending { background-color: #6c757d; }
    
    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .progress-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .overall-progress {
        height: 25px;
        background: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-bar-custom {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        border-radius: 15px;
        transition: width 0.5s ease;
        position: relative;
    }
    
    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    
    .log-container {
        background: #1e1e1e;
        color: #00ff00;
        border-radius: 10px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        margin: 20px 0;
        border: 1px solid #333;
    }
    
    .log-entry {
        margin: 2px 0;
        padding: 2px 0;
    }
    
    .log-info { color: #00ff00; }
    .log-warning { color: #ffff00; }
    .log-error { color: #ff0000; }
    .log-success { color: #00ffff; }
    
    .model-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .model-status-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .model-status-card:hover {
        transform: translateY(-3px);
    }
    
    .model-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
    
    .btn-view-results {
        background: linear-gradient(135deg, var(--success-color) 0%, #20c997 100%);
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-view-results:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .text-purple {
        color: #6f42c1 !important;
    }
    
    .text-cyan {
        color: #17a2b8 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('dataset_overview', dataset_name=dataset_name) }}">{{ dataset_name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('model_configuration', dataset_name=dataset_name) }}">Model Config</a></li>
            <li class="breadcrumb-item active" aria-current="page">Training Pipeline</li>
        </ol>
    </nav>

    <!-- Progress Steps -->
    <div class="progress-steps">
        <div class="step completed">
            <div class="step-number"><i class="fas fa-check"></i></div>
            <small>Data Upload</small>
        </div>
        <div class="step completed">
            <div class="step-number"><i class="fas fa-check"></i></div>
            <small>Feature Extraction</small>
        </div>
        <div class="step completed">
            <div class="step-number"><i class="fas fa-check"></i></div>
            <small>Feature Results</small>
        </div>
        <div class="step completed">
            <div class="step-number"><i class="fas fa-check"></i></div>
            <small>Model Config</small>
        </div>
        <div class="step active">
            <div class="step-number">5</div>
            <small>Training</small>
        </div>
        <div class="step">
            <div class="step-number">6</div>
            <small>Results</small>
        </div>
    </div>

    <!-- Header -->
    <div class="training-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-rocket me-3"></i>Training Pipeline
                </h1>
                <p class="lead mb-0">
                    Training advanced misinformation detection models on <strong>{{ dataset_name }}</strong>
                </p>
                <p class="mb-0 mt-2">
                    <i class="fas fa-info-circle me-2"></i>
                    Watch as your models learn to detect misinformation patterns in real-time
                </p>
            </div>
            <div class="col-md-4 text-end">
                <i class="fas fa-cogs fa-spin" style="font-size: 5rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>

    <!-- Pipeline Analysis Summary -->
    {% if feature_results and feature_results.feature_breakdown %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Feature Engineering Summary
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Advanced feature extraction combining traditional NLP with behavioral analysis and theoretical frameworks
                    </p>
                    <div class="row text-center">
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ feature_results.feature_breakdown.text or 0 }}</div>
                                <small class="text-muted">Text Features</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-info">{{ feature_results.feature_breakdown.behavioral or 0 }}</div>
                                <small class="text-muted">Behavioral Features</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-secondary">{{ feature_results.feature_breakdown.theoretical or 0 }}</div>
                                <small class="text-muted">Theoretical Features</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-warning">{{ feature_results.feature_breakdown.sentiment or 0 }}</div>
                                <small class="text-muted">Sentiment Features</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-success">{{ feature_results.feature_breakdown.transformer_embeddings or 0 }}</div>
                                <small class="text-muted">Transformer Features</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 text-dark"><strong>{{ feature_results.total_features or 0 }}</strong></div>
                                <small class="text-muted"><strong>Total Features</strong></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional feature types row -->
                    {% if feature_results.feature_breakdown.network or feature_results.feature_breakdown.enhanced_text or feature_results.feature_breakdown.zero_shot %}
                    <div class="row text-center mt-3">
                        {% if feature_results.feature_breakdown.network %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h5 text-danger">{{ feature_results.feature_breakdown.network or 0 }}</div>
                                <small class="text-muted">Network Features</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if feature_results.feature_breakdown.enhanced_text %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h5 text-purple">{{ feature_results.feature_breakdown.enhanced_text or 0 }}</div>
                                <small class="text-muted">Enhanced Text Features</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if feature_results.feature_breakdown.zero_shot %}
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h5 text-cyan">{{ feature_results.feature_breakdown.zero_shot or 0 }}</div>
                                <small class="text-muted">Zero-Shot Features</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Ready for Training:</strong> 
                            All feature extraction completed successfully. 
                            Using {{ feature_results.extraction_mode or 'enhanced' }} mode with 
                            {{ feature_results.total_features or 0 }} total features.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Theoretical Framework Insights -->
    {% if feature_results and feature_results.theoretical_insights and feature_results.theoretical_insights.rat_risk_perception is defined %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>Theoretical Framework Analysis (RAT/RCT)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Routine Activity Theory and Rational Choice Theory insights for misinformation behavior analysis
                    </p>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-danger">{{ "%.2f"|format(feature_results.theoretical_insights.rat_risk_perception) }}</div>
                                <small class="text-muted">Risk Perception (RAT)</small>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-danger" style="width: {{ (feature_results.theoretical_insights.rat_risk_perception * 100)|round }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-success">{{ "%.2f"|format(feature_results.theoretical_insights.rat_benefit_perception) }}</div>
                                <small class="text-muted">Benefit Perception (RAT)</small>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: {{ (feature_results.theoretical_insights.rat_benefit_perception * 100)|round }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ "%.2f"|format(feature_results.theoretical_insights.rct_coping_appraisal) }}</div>
                                <small class="text-muted">Coping Appraisal (RCT)</small>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-primary" style="width: {{ (feature_results.theoretical_insights.rct_coping_appraisal * 100)|round }}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-warning">{{ "%.2f"|format(feature_results.theoretical_insights.rct_threat_appraisal) }}</div>
                                <small class="text-muted">Threat Appraisal (RCT)</small>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar bg-warning" style="width: {{ (feature_results.theoretical_insights.rct_threat_appraisal * 100)|round }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Model Configuration Summary -->
    {% if model_config %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Model Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Framework Type</h6>
                            <p class="mb-3">{{ model_config.framework_type|replace('_', ' ')|title }}</p>
                            
                            <h6 class="text-primary">Training Algorithms</h6>
                            <div class="mb-3">
                                {% for algo in model_config.traditional_algorithms %}
                                <span class="badge bg-primary me-1 mb-1">{{ algo|replace('_', ' ')|title }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Feature Configuration</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-{{ 'check text-success' if model_config.feature_config.use_transformer_embeddings else 'times text-danger' }} me-2"></i>Transformer Embeddings</li>
                                <li><i class="fas fa-{{ 'check text-success' if model_config.feature_config.use_theoretical_frameworks else 'times text-danger' }} me-2"></i>Theoretical Frameworks</li>
                                <li><i class="fas fa-{{ 'check text-success' if model_config.feature_config.use_behavioral_features else 'times text-danger' }} me-2"></i>Behavioral Features</li>
                            </ul>
                            
                            <h6 class="text-info">Training Parameters</h6>
                            <small class="text-muted">
                                Train/Test Split: {{ (model_config.training_params.train_size * 100)|round }}%/{{ ((1 - model_config.training_params.train_size) * 100)|round }}% | 
                                CV Folds: {{ model_config.training_params.cv_folds }} | 
                                Metric: {{ model_config.training_params.scoring_metric|title }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}



    <!-- Overall Progress -->
    <div class="progress-container">
        <h3 class="mb-3">
            <i class="fas fa-chart-line me-2"></i>Training Progress
        </h3>
        <div class="overall-progress">
            <div class="progress-bar-custom" id="overallProgress" style="width: 0%;">
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
        <div class="mt-3 text-center">
            <span id="currentStage">Ready to train your misinformation detection models</span>
        </div>
    </div>

    <!-- Training Insights -->
    {% if insights %}
        {% include 'insights_component.html' %}
    {% endif %}

    <!-- Existing Results Summary -->
    {% if completed_models is defined and completed_models > 0 %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="alert alert-success border-0 shadow-sm">
                <div class="row align-items-center">
                    <div class="col-md-1 text-center">
                        <i class="fas fa-check-circle text-success" style="font-size: 2.5rem;"></i>
                    </div>
                    <div class="col-md-8">
                        <h5 class="alert-heading mb-2">
                            <i class="fas fa-robot me-2"></i>Comprehensive Training Complete
                        </h5>
                        <p class="mb-1">
                            <strong>{{ completed_models if completed_models is defined else 0 }}</strong> individual models trained across multiple algorithms and feature combinations
                            {% if total_ensembles is defined and total_ensembles > 0 %}
                            + <strong>{{ total_ensembles }}</strong> ensemble packages
                            {% endif %}
                        </p>
                        <p class="mb-0">
                            <i class="fas fa-check-circle me-1 text-success"></i>
                            All major algorithms tested: Logistic Regression, Naive Bayes, Random Forest, XGBoost, SVM, Neural Network
                        </p>
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="/training_results/{{ dataset_name }}" class="btn btn-success btn-lg mb-2">
                            <i class="fas fa-eye me-2"></i>View Results
                        </a>
                        <br>
                        <button type="button" class="btn btn-outline-primary" onclick="showTrainingCards()">
                            <i class="fas fa-play me-2"></i>Continue Training
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Model Breakdown -->
    {% if completed_model_list is defined and completed_model_list|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-alt me-2"></i>Trained Models Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Algorithms & Feature Combinations</h6>
                            <div class="row">
                                {% set algorithms = ['logistic_regression', 'naive_bayes', 'random_forest', 'xgboost', 'svm', 'neural_network'] %}
                                {% for algorithm in algorithms %}
                                    {% set algo_count = 0 %}
                                    {% if completed_model_list is defined %}
                                        {% for model in completed_model_list %}
                                            {% if model.startswith(algorithm) %}
                                                {% set algo_count = algo_count + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% if algo_count > 0 %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-left-primary">
                                            <div class="card-body py-2">
                                                <h6 class="text-primary mb-1">{{ algorithm.replace('_', ' ').title() }}</h6>
                                                <small class="text-muted">{{ algo_count }} models</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Feature Combinations Tested</h6>
                            <div class="row">
                                {% set feature_combos = ['base_model', 'behavioral_features', 'complete_model', 'framework_embeddings_all', 'rat_framework', 'rct_framework', 'transformer_embeddings', 'ugt_framework'] %}
                                {% for combo in feature_combos %}
                                    {% set combo_count = 0 %}
                                    {% if completed_model_list is defined %}
                                        {% for model in completed_model_list %}
                                            {% if combo in model %}
                                                {% set combo_count = combo_count + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% if combo_count > 0 %}
                                    <div class="col-md-12 mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-dark">{{ combo.replace('_', ' ').title() }}</span>
                                            <span class="badge bg-secondary">{{ combo_count }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    {% if ensemble_packages is defined and ensemble_packages|length > 0 %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted mb-2">Ensemble Packages</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for ensemble in ensemble_packages %}
                                <span class="badge bg-success">{{ ensemble.replace('.pkl', '').replace('_', ' ').title() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Unified Framework Results Summary -->
    {% if unified_results %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Unified Framework Training Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-success">{{ unified_results.total_models_trained or 0 }}</div>
                                <small class="text-muted">Models Trained</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ unified_results.algorithms_tested|length if unified_results.algorithms_tested else 0 }}</div>
                                <small class="text-muted">Algorithms Tested</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-info">{{ unified_results.combinations_tested|length if unified_results.combinations_tested else 0 }}</div>
                                <small class="text-muted">Feature Combinations</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="h4 text-warning">{{ "%.1f"|format(unified_results.zero_shot_results.average_confidence * 100) if unified_results.zero_shot_results else 0 }}%</div>
                                <small class="text-muted">Avg Confidence</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if unified_results.algorithms_tested %}
                    <div class="mt-3">
                        <h6 class="text-primary">Algorithms Tested:</h6>
                        <div class="mb-2">
                            {% for algo in unified_results.algorithms_tested %}
                            <span class="badge bg-primary me-1">{{ algo|replace('_', ' ')|title }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if unified_results.combinations_tested %}
                    <div class="mt-2">
                        <h6 class="text-info">Feature Combinations:</h6>
                        <div class="mb-2">
                            {% for combo in unified_results.combinations_tested %}
                            <span class="badge bg-info me-1">{{ combo|replace('_', ' ')|title }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Training Completed:</strong> {{ unified_results.training_date[:10] if unified_results.training_date else 'Unknown' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modular Training Pipeline -->
    <div class="row" id="trainingCardsSection" {% if completed_models is defined and completed_models > 0 %}style="display: none;"{% endif %}>
        <div class="col-md-12">
            <h3 class="mb-4">
                <i class="fas fa-layer-group me-2"></i>Modular Training Pipeline
            </h3>
            <p class="text-muted mb-4">
                Train each model individually with different feature combinations. Start with base features, then progressively add advanced features.
            </p>
            
            <!-- Training Order: LR, NB, RF, XGBoost, SVM, Neural Network -->
            {% for model in model_order %}
            {% set model_display_names = {
                'logistic_regression': 'Logistic Regression',
                'naive_bayes': 'Naive Bayes', 
                'random_forest': 'Random Forest',
                'xgboost': 'XGBoost',
                'svm': 'Support Vector Machine',
                'neural_network': 'Neural Network'
            } %}
            {% set model_icons = {
                'logistic_regression': 'fas fa-chart-line',
                'naive_bayes': 'fas fa-brain',
                'random_forest': 'fas fa-tree',
                'xgboost': 'fas fa-rocket',
                'svm': 'fas fa-vector-square',
                'neural_network': 'fas fa-network-wired'
            } %}
            {% set model_times = {
                'logistic_regression': '2-5 mins',
                'naive_bayes': '1-3 mins',
                'random_forest': '10-30 mins',
                'xgboost': '60-180 mins',
                'svm': '30-120 mins',
                'neural_network': '120-240 mins'
            } %}
            
            <div class="model-training-card mb-4" id="card-{{ model }}">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    <i class="{{ model_icons[model] }} me-2"></i>{{ model_display_names[model] }}
                                </h5>
                                <small class="text-muted">Estimated time: {{ model_times[model] }}</small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-info">{{ loop.index }}/6</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Feature Combination Progress -->
                        <div class="row">
                            {% for feature_combo in feature_combinations %}
                            {% set combo_display_names = {
                                'base_model': 'Base Model (TD + LDA)',
                                'framework_embeddings_all': 'Base + All Framework Embeddings',
                                'framework_embeddings_individual': 'Base + Individual Framework Embeddings',
                                'transformer_embeddings': 'Base + Transformer Embeddings',
                                'complete_model': 'Complete Model (All Features)'
                            } %}
                            
                            <div class="col-md-12 mb-2">
                                <div class="feature-combo-row">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <small class="text-muted">{{ combo_display_names[feature_combo] }}</small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            {% if existing_models[model][feature_combo]['trained'] %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Completed
                                            </span>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="trainModelFeatureCombo('{{ model }}', '{{ feature_combo }}')">
                                                <i class="fas fa-play me-1"></i>Train
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Results if available -->
                                    {% if existing_models[model][feature_combo]['trained'] %}
                                    <div class="row mt-1">
                                        <div class="col-md-12">
                                            <div class="small text-success">
                                                Accuracy: {{ "%.2f"|format(existing_models[model][feature_combo]['accuracy'] * 100) }}% | 
                                                F1-Score: {{ "%.3f"|format(existing_models[model][feature_combo]['f1_score']) }} | 
                                                Time: {{ existing_models[model][feature_combo]['training_time'] }}s
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Overall Model Status -->
                        {% set trained_combos = existing_models[model].values() | selectattr('trained') | list | length %}
                        <div class="mt-3 pt-3 border-top">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <strong>Overall Progress: {{ trained_combos }}/{{ feature_combinations|length }} combinations</strong>
                                </div>
                                <div class="col-md-4 text-end">
                                    {% if trained_combos == feature_combinations|length %}
                                    <span class="badge bg-success">All Complete</span>
                                    {% elif trained_combos > 0 %}
                                    <span class="badge bg-warning">Partial</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Not Started</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Model Status Grid -->
    <div class="progress-container">
        <h3 class="mb-3">
            <i class="fas fa-robot me-2"></i>Your AI Models
        </h3>
        <div class="model-status-grid" id="modelStatusGrid">
            <!-- Model status cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Training Logs -->
    <div class="progress-container">
        <h3 class="mb-3">
            <i class="fas fa-terminal me-2"></i>Live Training Progress
        </h3>
        <div class="log-container" id="trainingLogs">
            <div class="log-entry log-info">[INFO] Ready to begin training your misinformation detection models...</div>
            <div class="log-entry log-info">[INFO] Click 'Begin Training' to start the machine learning process</div>
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="text-center mt-4">
        <button id="startTrainingBtn" class="btn btn-primary btn-lg me-3" onclick="startTraining()">
            <i class="fas fa-play me-2"></i>Begin Training
        </button>
        <button id="stopTrainingBtn" class="btn btn-danger btn-lg me-3" onclick="stopTraining()" disabled>
            <i class="fas fa-stop me-2"></i>Stop Training
        </button>
        <button id="viewResultsBtn" class="btn btn-view-results text-white btn-lg" onclick="viewResults()" disabled>
            <i class="fas fa-chart-line me-2"></i>View Results
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Training state management - tracks your model training journey
    let trainingInProgress = false;
    let progressInterval;
    let logInterval;
    let currentStep = 0;
    const totalSteps = 6;
    
    // Training pipeline steps - baseline model training process
    const steps = [
        'step-feature-loading',
        'step-data-split',
        'step-model-training', 
        'step-cross-validation',
        'step-evaluation',
        'step-results'
    ];
    
    const stepNames = [
        'Feature Loading',
        'Train/Test Split',
        'Model Training',
        'Cross Validation', 
        'Model Evaluation',
        'Results Generation'
    ];

    function startTraining() {
        // Begin the exciting journey of training your AI models!
        if (trainingInProgress) return;
        
        trainingInProgress = true;
        document.getElementById('startTrainingBtn').disabled = true;
        document.getElementById('stopTrainingBtn').disabled = false;
        document.getElementById('viewResultsBtn').disabled = true;
        
        // Reset progress
        currentStep = 0;
        updateOverallProgress(0);
        resetAllSteps();
        
        // Add initial log
        addLog('Initializing your misinformation detection training...', 'info');
        
        // Start progress monitoring
        progressInterval = setInterval(updateProgress, 2000);
        logInterval = setInterval(fetchLogs, 3000);
        
        // Initialize model status grid
        initializeModelStatusGrid();
        
        // Connect to the server to begin your model training
        addLog('Starting training pipeline...', 'info');
        fetch('/start_training_pipeline', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dataset_name: {{ dataset_name|tojson }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                addLog('Training pipeline completed successfully!', 'success');
                addLog(`Trained models: ${data.models ? data.models.join(', ') : 'N/A'}`, 'info');
                
                // Show completion progress
                updateOverallProgress(100);
                completeAllSteps();
                
                // Enable view results button
                document.getElementById('viewResultsBtn').disabled = false;
                
                // Check if there's a redirect URL
                if (data.redirect) {
                    addLog('Training results are ready! Click "View Results" or wait for auto-redirect...', 'info');
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 5000); // Increased delay to 5 seconds
                } else {
                    addLog('Training pipeline started! Your models are now learning...', 'success');
                }
                
                // Stop progress monitoring
                stopTraining();
            } else {
                addLog('Error starting training: ' + data.message, 'error');
                stopTraining();
            }
        })
        .catch(error => {
            addLog('Error: ' + error.message, 'error');
            stopTraining();
        });
    }
    
    function stopTraining() {
        trainingInProgress = false;
        clearInterval(progressInterval);
        clearInterval(logInterval);
        
        document.getElementById('startTrainingBtn').disabled = false;
        document.getElementById('stopTrainingBtn').disabled = true;
        
        addLog('Training stopped by user', 'warning');
    }
    
    function updateProgress() {
        if (!trainingInProgress) return;
        
        fetch('/training_progress')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addLog('Error fetching progress: ' + data.error, 'error');
                return;
            }
            
            // Update overall progress
            updateOverallProgress(data.overall_progress || 0);
            
            // Update current stage
            const currentStageElement = document.getElementById('currentStage');
            if (currentStageElement) {
                currentStageElement.textContent = data.current_stage || 'Processing...';
            }
            
            // Update step statuses (using actual step IDs from HTML)
            updateStepStatus('step-feature-loading', data.data_prep_status || 'pending');
            updateStepStatus('step-data-split', data.data_split_status || 'pending');
            updateStepStatus('step-model-training', data.model_training_status || 'pending');
            updateStepStatus('step-cross-validation', data.cross_validation_status || 'pending');
            updateStepStatus('step-evaluation', data.evaluation_status || 'pending');
            updateStepStatus('step-results', data.results_status || 'pending');
            
            // Update model statuses
            if (data.model_statuses) {
                updateModelStatusGrid(data.model_statuses);
            }
            
            // Check if training is complete
            if (data.overall_progress >= 100) {
                trainingCompleted();
            }
        })
        .catch(error => {
            addLog('Error fetching progress: ' + error.message, 'error');
        });
    }
    
    function fetchLogs() {
        if (!trainingInProgress) return;
        
        fetch('/training_logs')
        .then(response => response.json())
        .then(data => {
            if (data.logs) {
                data.logs.forEach(log => {
                    addLog(log.message, log.level);
                });
            }
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
        });
    }
    
    function updateOverallProgress(progress) {
        const progressBar = document.getElementById('overallProgress');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        if (progressText) {
            progressText.textContent = Math.round(progress) + '%';
        }
    }
    
    function updateStepStatus(stepId, status) {
        const stepElement = document.getElementById(stepId);
        const statusElement = document.getElementById('status-' + stepId.replace('step-', ''));
        const badgeElement = document.getElementById('badge-' + stepId.replace('step-', ''));
        
        // Check if elements exist before manipulating them
        if (!stepElement || !statusElement || !badgeElement) {
            return; // Skip if elements don't exist
        }
        
        // Remove all status classes
        stepElement.classList.remove('step-pending', 'step-running', 'step-completed', 'step-error');
        statusElement.classList.remove('status-pending', 'status-running', 'status-ready', 'status-error');
        badgeElement.classList.remove('badge-pending', 'badge-running', 'badge-completed', 'badge-error');
        
        // Add new status classes
        stepElement.classList.add('step-' + status);
        statusElement.classList.add('status-' + (status === 'completed' ? 'ready' : status));
        badgeElement.classList.add('badge-' + status);
        badgeElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    }
    
    function resetAllSteps() {
        steps.forEach(stepId => {
            updateStepStatus(stepId, 'pending');
        });
    }
    
    function completeAllSteps() {
        steps.forEach(stepId => {
            updateStepStatus(stepId, 'completed');
        });
    }
    
    function addLog(message, level = 'info') {
        const logsContainer = document.getElementById('trainingLogs');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${level}`;
        logEntry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
        
        logsContainer.appendChild(logEntry);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }
    
    function initializeModelStatusGrid() {
        const grid = document.getElementById('modelStatusGrid');
        const models = {% if selected_models is defined %}{{ selected_models|tojson }}{% else %}['logistic_regression', 'naive_bayes', 'random_forest']{% endif %};
        
        grid.innerHTML = '';
        
        models.forEach(model => {
            const modelCard = document.createElement('div');
            modelCard.className = 'model-status-card';
            modelCard.id = `model-${model}`;
            
            const iconClass = model === 'logistic_regression' ? 'fa-chart-line' : 
                             model === 'naive_bayes' ? 'fa-chart-bar' : 
                             model === 'zero_shot' ? 'fa-brain' :
                             model === 'gradient_boosting' ? 'fa-rocket' :
                             model === 'svm' ? 'fa-vector-square' :
                             model === 'neural_network' ? 'fa-network-wired' :
                             'fa-tree';
            
            const modelName = model.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            modelCard.innerHTML = `
                <i class="fas ${iconClass} model-icon text-secondary"></i>
                <h5>${modelName}</h5>
                <div class="status-indicator status-pending" id="model-status-${model}"></div>
                <span id="model-text-${model}">Ready to learn</span>
            `;
            
            grid.appendChild(modelCard);
        });
    }
    
    function updateModelStatusGrid(modelStatuses) {
        Object.keys(modelStatuses).forEach(model => {
            const statusElement = document.getElementById(`model-status-${model}`);
            const textElement = document.getElementById(`model-text-${model}`);
            const cardElement = document.getElementById(`model-${model}`);
            
            if (statusElement && textElement) {
                const status = modelStatuses[model];
                
                // Update status indicator
                statusElement.classList.remove('status-pending', 'status-running', 'status-ready', 'status-error');
                statusElement.classList.add('status-' + (status.status === 'completed' ? 'ready' : status.status));
                
                // Update text
                textElement.textContent = status.message || status.status;
                
                // Update card icon color
                const icon = cardElement.querySelector('.model-icon');
                icon.classList.remove('text-secondary', 'text-warning', 'text-success', 'text-danger');
                
                switch(status.status) {
                    case 'running':
                        icon.classList.add('text-warning');
                        break;
                    case 'completed':
                        icon.classList.add('text-success');
                        break;
                    case 'error':
                        icon.classList.add('text-danger');
                        break;
                    default:
                        icon.classList.add('text-secondary');
                }
            }
        });
    }
    
    function trainingCompleted() {
        trainingInProgress = false;
        clearInterval(progressInterval);
        clearInterval(logInterval);
        
        document.getElementById('startTrainingBtn').disabled = false;
        document.getElementById('stopTrainingBtn').disabled = true;
        document.getElementById('viewResultsBtn').disabled = false;
        
        addLog('Training completed! Your misinformation detection models are ready!', 'success');
        addLog('Redirecting to view your results...', 'info');
        
        // Automatically redirect to results after 3 seconds
        setTimeout(() => {
            viewResults();
        }, 3000);
    }
    
    function viewResults() {
        window.location.href = `/unified_framework_results/` + {{ dataset_name|tojson }};
    }
    
    // Manual training start only - no auto-start to avoid conflicts
    
    // Modular Training Functions
    function showTrainingCards() {
        // Hide existing results section and show training cards
        const existingSection = document.querySelector('.alert-success').closest('.row');
        const trainingSection = document.getElementById('trainingCardsSection');
        
        if (existingSection) {
            existingSection.style.display = 'none';
        }
        if (trainingSection) {
            trainingSection.style.display = 'block';
        }
        
        // Scroll to the training section
        trainingSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function trainModelFeatureCombo(model, featureCombo) {
        // Show training in progress for this specific combination
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Training...';
        button.disabled = true;
        
        // Start training for this specific model and feature combination
        fetch('/train_model_combo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dataset_name: '{{ dataset_name }}',
                model: model,
                feature_combo: featureCombo
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the UI with results
                const row = button.closest('.feature-combo-row');
                const resultsDiv = row.querySelector('.row.mt-1') || document.createElement('div');
                
                if (!row.querySelector('.row.mt-1')) {
                    resultsDiv.className = 'row mt-1';
                    resultsDiv.innerHTML = `
                        <div class="col-md-12">
                            <div class="small text-success">
                                Accuracy: ${(data.results.accuracy * 100).toFixed(2)}% | 
                                F1-Score: ${data.results.f1_score.toFixed(3)} | 
                                Time: ${data.results.training_time}s
                            </div>
                        </div>
                    `;
                    row.appendChild(resultsDiv);
                }
                
                // Replace button with completed badge
                button.outerHTML = `
                    <span class="badge bg-success">
                        <i class="fas fa-check me-1"></i>Completed
                    </span>
                `;
                
                // Update overall model progress
                updateModelProgress(model);
                
            } else {
                // Show error
                button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
                button.className = 'btn btn-sm btn-outline-danger';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.className = 'btn btn-sm btn-outline-primary';
                    button.disabled = false;
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Training error:', error);
            button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
            button.className = 'btn btn-sm btn-outline-danger';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.className = 'btn btn-sm btn-outline-primary';
                button.disabled = false;
            }, 3000);
        });
    }
    
    function updateModelProgress(model) {
        // Count completed combinations for this model
        const modelCard = document.getElementById(`card-${model}`);
        const completedBadges = modelCard.querySelectorAll('.badge.bg-success').length;
        const totalCombos = {{ feature_combinations|length }};
        
        // Update the overall progress badge
        const progressBadge = modelCard.querySelector('.card-header .col-md-4 .badge');
        const statusBadge = modelCard.querySelector('.border-top .col-md-4 .badge');
        
        if (completedBadges === totalCombos) {
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'All Complete';
        } else if (completedBadges > 0) {
            statusBadge.className = 'badge bg-warning';
            statusBadge.textContent = 'Partial';
        }
        
        // Update progress text
        const progressText = modelCard.querySelector('.border-top .col-md-8 strong');
        progressText.textContent = `Overall Progress: ${completedBadges}/${totalCombos} combinations`;
    }
    
    function showTrainingCards() {
        // Hide existing results section and show training cards section
        const existingSection = document.querySelector('.alert-success').closest('.row');
        const trainingSection = document.getElementById('trainingCardsSection');
        
        if (existingSection) {
            existingSection.style.display = 'none';
        }
        if (trainingSection) {
            trainingSection.style.display = 'block';
        }
        
        // Scroll to the training section
        trainingSection.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %}